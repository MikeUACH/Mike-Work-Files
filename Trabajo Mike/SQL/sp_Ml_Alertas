/****** Object:  StoredProcedure [dbo].[sp_ml_Alertas]    Script Date: 6/18/2024 4:02:07 PM ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

ALTER PROCEDURE [dbo].[sp_ml_Alertas]
AS
BEGIN
    DECLARE @idTendencia BIGINT;
    DECLARE @idGas BIGINT;
    DECLARE @mes INT;
    DECLARE @tipoAlerta VARCHAR(10);
    DECLARE @alertaActiva BIT;
    DECLARE @idLlave BIGINT;
    DECLARE @limite NUMERIC(10,4);
    DECLARE @valor30 NUMERIC(10,4);
    DECLARE @valor60 NUMERIC(10,4);
    DECLARE @valor90 NUMERIC(10,4);
    DECLARE @fecha DATETIME;
    DECLARE @idAlerta BIGINT;

    -- Obtener todas las tendencias que superan los límites
    DECLARE tendencia_cursor CURSOR FOR
    SELECT t.id AS idTendencia, t.idGas, t.Fecha, t.v30, t.v60, t.v90, l.limite, ll.id AS idLlave
    FROM dbo.ml_Tendencia t
    JOIN dbo.ml_Gas_Limite l ON t.idGas = l.id
    JOIN dbo.ml_LlavesG ll ON t.id = ll.idTend
    WHERE t.v30 > l.limite OR t.v60 > l.limite OR t.v90 > l.limite;

    OPEN tendencia_cursor;
    FETCH NEXT FROM tendencia_cursor INTO @idTendencia, @idGas, @fecha, @valor30, @valor60, @valor90, @limite, @idLlave;

    WHILE @@FETCH_STATUS = 0
    BEGIN
        -- Determinar el mes de la alerta
        SET @mes = MONTH(@fecha);

        -- Insertar alerta para v90 si supera el límite
        IF @valor90 > @limite
        BEGIN
            SET @tipoAlerta = 'v90';
            SET @alertaActiva = 1; -- Asumimos que todas las alertas están activas al momento de creación
            INSERT INTO dbo.ml_Gas_Alerta (mes, tipoAlerta, idTendencia, idLlave, idGas, valorActual)
            VALUES (@mes, @tipoAlerta, @idTendencia, @idLlave, @idGas, @valor90);
            SET @idAlerta = SCOPE_IDENTITY(); -- Obtener el id de la alerta recién insertada

            -- Enviar alerta a los usuarios
            INSERT INTO dbo.Usuarios_gas (correoUser, alertaActiva, CuerpoCorreo, fechaEnvio, idLlave, idAlerta)
            SELECT u.correoUser, 1, CONCAT('Alerta de ', @tipoAlerta, ' superada.'), GETDATE(), @idLlave, @idAlerta
            FROM dbo.Usuarios_gas u;
        END
        -- Insertar alerta para v60 si supera el límite y no se ha insertado una alerta para v90
        ELSE IF @valor60 > @limite
        BEGIN
            SET @tipoAlerta = 'v60';
            SET @alertaActiva = 1; -- Asumimos que todas las alertas están activas al momento de creación
            INSERT INTO dbo.ml_Gas_Alerta (mes, tipoAlerta, idTendencia, idLlave, idGas, valorActual)
            VALUES (@mes, @tipoAlerta, @idTendencia, @idLlave, @idGas, @valor60);
            SET @idAlerta = SCOPE_IDENTITY(); -- Obtener el id de la alerta recién insertada

            -- Enviar alerta a los usuarios
            INSERT INTO dbo.Usuarios_gas (correoUser, alertaActiva, CuerpoCorreo, fechaEnvio, idLlave, idAlerta)
            SELECT u.correoUser, 1, CONCAT('Alerta de ', @tipoAlerta, ' superada.'), GETDATE(), @idLlave, @idAlerta
            FROM dbo.Usuarios_gas u;
        END
        -- Insertar alerta para v30 si supera el límite y no se ha insertado una alerta para v90 o v60
        ELSE IF @valor30 > @limite
        BEGIN
            SET @tipoAlerta = 'v30';
            SET @alertaActiva = 1; -- Asumimos que todas las alertas están activas al momento de creación
            INSERT INTO dbo.ml_Gas_Alerta (mes, tipoAlerta, idTendencia, idLlave, idGas, valorActual)
            VALUES (@mes, @tipoAlerta, @idTendencia, @idLlave, @idGas, @valor30);
            SET @idAlerta = SCOPE_IDENTITY(); -- Obtener el id de la alerta recién insertada

            -- Enviar alerta a los usuarios
            INSERT INTO dbo.Usuarios_gas (correoUser, alertaActiva, CuerpoCorreo, fechaEnvio, idLlave, idAlerta)
            SELECT u.correoUser, 1, CONCAT('Alerta de ', @tipoAlerta, ' superada.'), GETDATE(), @idLlave, @idAlerta
            FROM dbo.Usuarios_gas u;
        END
        -- Si ninguna alerta supera el límite, insertar todas las alertas juntas
        ELSE
        BEGIN
            SET @alertaActiva = 1; -- Asumimos que todas las alertas están activas al momento de creación

            -- Insertar alerta para v90
            SET @tipoAlerta = 'v90';
            INSERT INTO dbo.ml_Gas_Alerta (mes, tipoAlerta, idTendencia, idLlave, idGas, valorActual)
            VALUES (@mes, @tipoAlerta, @idTendencia, @idLlave, @idGas, @valor90);
            SET @idAlerta = SCOPE_IDENTITY(); -- Obtener el id de la alerta recién insertada

            -- Enviar alerta a los usuarios
            INSERT INTO dbo.Usuarios_gas (correoUser, alertaActiva, CuerpoCorreo, fechaEnvio, idLlave, idAlerta)
            SELECT u.correoUser, 1, CONCAT('Alerta de ', @tipoAlerta, ' superada.'), GETDATE(), @idLlave, @idAlerta
            FROM dbo.Usuarios_gas u;

            -- Insertar alerta para v60
            SET @tipoAlerta = 'v60';
            INSERT INTO dbo.ml_Gas_Alerta (mes, tipoAlerta, idTendencia, idLlave, idGas, valorActual)
            VALUES (@mes, @tipoAlerta, @idTendencia, @idLlave, @idGas, @valor60);
            SET @idAlerta = SCOPE_IDENTITY(); -- Obtener el id de la alerta recién insertada

            -- Enviar alerta a los usuarios
            INSERT INTO dbo.Usuarios_gas (correoUser, alertaActiva, CuerpoCorreo, fechaEnvio, idLlave, idAlerta)
            SELECT u.correoUser, 1, CONCAT('Alerta de ', @tipoAlerta, ' superada.'), GETDATE(), @idLlave, @idAlerta
            FROM dbo.Usuarios_gas u;

            -- Insertar alerta para v30
            SET @tipoAlerta = 'v30';
            INSERT INTO dbo.ml_Gas_Alerta (mes, tipoAlerta, idTendencia, idLlave, idGas, valorActual)
            VALUES (@mes, @tipoAlerta, @idTendencia, @idLlave, @idGas, @valor30);
            SET @idAlerta = SCOPE_IDENTITY(); -- Obtener el id de la alerta recién insertada

            -- Enviar alerta a los usuarios
            INSERT INTO dbo.Usuarios_gas (correoUser, alertaActiva, CuerpoCorreo, fechaEnvio, idLlave, idAlerta)
            SELECT u.correoUser, 1, CONCAT('Alerta de ', @tipoAlerta, ' superada.'), GETDATE(), @idLlave, @idAlerta
            FROM dbo.Usuarios_gas u;
        END

        FETCH NEXT FROM tendencia_cursor INTO @idTendencia, @idGas, @fecha, @valor30, @valor60, @valor90, @limite, @idLlave;
    END

    CLOSE tendencia_cursor;
    DEALLOCATE tendencia_cursor;
END
GO
